<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport setting untuk mencegah zoom yang tidak disengaja dan memastikan skala 1:1 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NUMERASIYU - HD 720p</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Memuat pustaka jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* Fallback untuk browser yang tidak support dvh */
            --vh: 1vh; 
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Mencegah perilaku bounce scroll default di iOS */
            overscroll-behavior: none; 
            /* Menggunakan Dynamic Viewport Height agar pas di layar mobile browser modern */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            /* Latar belakang gelap untuk fokus pada konten 720p di layar besar */
            background-color: #111827; 
        }
        
        .page.hidden { display: none; }

        /* Utilitas Transisi Halus */
        .transition-layout {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scanner Styles */
        #qr-scanner-container {
            background-color: #000;
            position: relative;
        }
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* KUNCI: Video mengisi container tanpa gepeng */
            display: block;
        }

        /* Animasi Laser Scanner */
        @keyframes scan-line {
            0% { top: 10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }
        .scan-laser {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: scan-line 2s infinite linear;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <!-- Hamparan Izin Sensor (Overlay) -->
    <div id="sensor-permission-overlay" class="fixed inset-0 bg-black/90 z-[9999] flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center space-y-4">
            <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <i data-lucide="scan-face" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900">Selamat Datang!</h2>
            <p class="text-sm text-gray-500">Aplikasi ini membutuhkan akses kamera dan sensor gerak untuk fitur interaktif.</p>
            <button id="grant-permission-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <span>Mulai Sekarang</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
            <p id="permission-status" class="text-[10px] text-gray-400 italic min-h-[1rem]"></p>
        </div>
    </div>

    <!-- Container Utama -->
    <!-- UPDATE: Max Width 1280px (720p width) & Aspect Ratio terjaga di desktop -->
    <div id="app-container" class="flex flex-col w-full h-full hidden max-w-[1280px] bg-white shadow-2xl mx-auto relative">
        
        <!-- Area Konten Utama -->
        <main class="flex-grow relative overflow-hidden w-full h-full bg-gray-50">
            
            <!-- PAGE 1: BERANDA -->
            <div id="page-awal" class="page w-full h-full relative flex flex-col items-center justify-center p-6">
                <!-- Background Image dengan Overlay -->
                <div class="absolute inset-0 z-0">
                    <img src="https://cdn.pixabay.com/photo/2021/05/05/11/43/modern-6230891_1280.png" class="w-full h-full object-cover opacity-20" alt="Background">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/0 via-white/50 to-white"></div>
                </div>

                <!-- Konten Beranda -->
                <div class="relative z-10 flex flex-col items-center max-w-md w-full text-center animate-fade-in-up">
                    <div class="w-24 h-24 md:w-32 md:h-32 bg-white rounded-2xl shadow-lg p-2 mb-6 flex items-center justify-center">
                        <img src="https://unnes.ac.id/lppm/wp-content/uploads/sites/16/2015/08/Logo-Transparan-Warna-1.png" 
                             alt="Logo UNNES" 
                             class="w-full h-auto object-contain"
                             onerror="this.src='https://placehold.co/200x200/F9E45B/003399?text=UNNES'; this.onerror=null;">
                    </div>
                    
                    <h1 class="text-3xl md:text-4xl font-black text-blue-900 mb-2 tracking-tight">NUMERASIYU</h1>
                    <div class="h-1 w-16 bg-yellow-400 rounded-full mb-4"></div>
                    <p class="text-gray-600 text-sm md:text-base font-medium">Media Pembelajaran Interaktif<br>Berbasis Augmented Reality</p>
                    
                    <div class="mt-8 grid grid-cols-2 gap-3 w-full px-4">
                        <div class="bg-white/80 backdrop-blur p-3 rounded-lg border border-blue-100 shadow-sm flex flex-col items-center gap-1">
                            <i data-lucide="scan" class="w-5 h-5 text-blue-500"></i>
                            <span class="text-xs font-semibold text-gray-600">QR Scan</span>
                        </div>
                        <div class="bg-white/80 backdrop-blur p-3 rounded-lg border border-green-100 shadow-sm flex flex-col items-center gap-1">
                            <i data-lucide="compass" class="w-5 h-5 text-green-500"></i>
                            <span class="text-xs font-semibold text-gray-600">Sensor AR</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: MATERI & SCANNER (LAYOUT ADAPTIF) -->
            <div id="page-materi" class="page w-full h-full hidden flex flex-col p-2 md:p-4 gap-2 md:gap-4">
                <!-- Header Kecil -->
                <div class="flex items-center gap-2 px-1 shrink-0">
                    <div class="p-1.5 bg-green-100 rounded-lg">
                        <i data-lucide="layers" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <h2 class="font-bold text-gray-800">Materi & Aktivitas</h2>
                </div>

                <!-- 
                   LOGIKA LAYOUT RESPONSIF:
                   - Portrait (Default): Flex-col (Atas Bawah)
                   - Landscape (Layar lebar/HP miring): Flex-row (Kiri Kanan)
                -->
                <div class="flex-grow flex flex-col md:flex-row landscape:flex-row gap-3 min-h-0 overflow-hidden">
                    
                    <!-- KIRI/ATAS: Iframe Materi -->
                    <div class="flex-1 bg-gray-100 rounded-xl border border-gray-200 overflow-hidden relative shadow-sm group">
                        <div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-md backdrop-blur z-10">Materi</div>
                        <iframe src="https://www.canva.com/design/DAG4vcThXDs/0x7N7lcxNemZgrtoXQ5JJg/view?embed" 
                                class="w-full h-full border-0" 
                                allow="fullscreen" loading="lazy"></iframe>
                    </div>

                    <!-- KANAN/BAWAH: Scanner -->
                    <div class="flex-1 flex flex-col bg-white rounded-xl border border-blue-100 shadow-sm overflow-hidden">
                        <!-- Header Scanner -->
                        <div class="p-2 border-b border-gray-100 flex justify-between items-center bg-blue-50/50 shrink-0">
                            <span class="text-xs font-bold text-blue-800 flex items-center gap-1">
                                <i data-lucide="scan-line" class="w-3 h-3"></i> Scanner
                            </span>
                            <div class="flex gap-1">
                                <span id="sensor-indicator" class="w-2 h-2 rounded-full bg-gray-300"></span>
                            </div>
                        </div>

                        <!-- Area Kamera (Relative agar video bisa absolute fill) -->
                        <div id="qr-scanner-ui" class="flex-grow relative bg-black w-full min-h-0">
                            <div id="qr-status-message" class="absolute inset-0 flex items-center justify-center text-white/70 text-xs p-4 text-center">
                                Menyiapkan kamera...
                            </div>

                            <!-- Container Video -->
                            <div id="qr-scanner-container" class="absolute inset-0 hidden">
                                <video id="qr-video" playsinline muted autoplay></video>
                                
                                <!-- Overlay UI -->
                                <div class="absolute inset-0 pointer-events-none">
                                    <!-- Sudut Fokus -->
                                    <div class="absolute top-4 left-4 w-8 h-8 border-t-2 border-l-2 border-white/50 rounded-tl-lg"></div>
                                    <div class="absolute top-4 right-4 w-8 h-8 border-t-2 border-r-2 border-white/50 rounded-tr-lg"></div>
                                    <div class="absolute bottom-4 left-4 w-8 h-8 border-b-2 border-l-2 border-white/50 rounded-bl-lg"></div>
                                    <div class="absolute bottom-4 right-4 w-8 h-8 border-b-2 border-r-2 border-white/50 rounded-br-lg"></div>
                                    
                                    <!-- Laser Animasi -->
                                    <div class="scan-laser"></div>
                                </div>

                                <!-- HUD Data Sensor (Overlay Pojok) -->
                                <div class="absolute top-2 left-2 right-2 flex flex-col gap-1 pointer-events-none">
                                    <div class="flex gap-1">
                                        <div class="bg-black/60 backdrop-blur text-white text-[9px] font-mono p-1 rounded border border-white/10 flex-1">
                                            <div class="text-yellow-400 font-bold mb-0.5">COMPASS (ABS)</div>
                                            <div class="grid grid-cols-3 gap-1">
                                                <span id="hud-alpha">A:--</span>
                                                <span id="hud-beta">B:--</span>
                                                <span id="hud-gamma">G:--</span>
                                            </div>
                                        </div>
                                        <div class="bg-black/60 backdrop-blur text-white text-[9px] font-mono p-1 rounded border border-white/10 flex-1">
                                            <div class="text-green-400 font-bold mb-0.5">GAME ROTATION</div>
                                            <div id="hud-game-quaternion" class="truncate">Waiting...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hasil Scan Overlay (Muncul saat sukses) -->
                            <div id="qr-result-container" class="absolute inset-0 bg-white z-20 hidden flex-col">
                                <div class="flex-1 relative bg-gray-50">
                                    <div id="qr-iframe-preview" class="absolute inset-0 hidden">
                                        <iframe id="qr-outputFrame" class="w-full h-full border-0"></iframe>
                                    </div>
                                    <div id="qr-data-preview" class="absolute inset-0 p-4 flex items-center justify-center hidden">
                                        <textarea id="qr-outputData" class="w-full h-32 p-2 text-sm bg-white border rounded resize-none" readonly></textarea>
                                    </div>
                                </div>
                                <div class="p-2 border-t bg-white flex gap-2 shrink-0">
                                    <button id="qr-copyButton" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-xs font-bold hover:bg-gray-200">Salin</button>
                                    <button id="qr-openLinkButton" class="flex-1 bg-purple-100 text-purple-700 py-2 rounded-lg text-xs font-bold hover:bg-purple-200 hidden">Buka Link</button>
                                    <button id="qr-scanAgainButton" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700">Scan Lagi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: ASESMEN -->
            <div id="page-asesmen" class="page w-full h-full hidden flex flex-col p-2 md:p-4 gap-2">
                <div class="flex items-center gap-2 px-1 shrink-0">
                    <div class="p-1.5 bg-red-100 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <h2 class="font-bold text-gray-800">Kuis & Evaluasi</h2>
                </div>
                <div class="flex-grow bg-white rounded-xl border border-red-100 shadow-sm overflow-hidden relative">
                    <iframe src="https://wayground.com/embed/quiz/66dc55162cbae50f1111bf98" 
                            class="w-full h-full border-0" 
                            allow="fullscreen"></iframe>
                </div>
            </div>

            <!-- PAGE 4: PROFIL (ADAPTIF STACK/SIDE) -->
            <div id="page-profil" class="page w-full h-full hidden flex flex-col p-4 md:p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col md:flex-row">
                    <!-- Kiri: Foto/Logo -->
                    <div class="bg-blue-50 p-8 flex items-center justify-center md:w-1/3 border-b md:border-b-0 md:border-r border-blue-100">
                        <div class="text-center">
                            <img src="https://unnes.ac.id/lppm/wp-content/uploads/sites/16/2015/08/Logo-Transparan-Warna-1.png" 
                                 class="w-32 h-auto mx-auto mb-4 drop-shadow-sm hover:scale-110 transition-transform" 
                                 alt="UNNES"
                                 onerror="this.src='https://placehold.co/150x150/F9E45B/003399?text=UNNES'; this.onerror=null;">
                            <h3 class="font-bold text-blue-900 text-lg">UNNES</h3>
                            <p class="text-[10px] font-bold tracking-widest text-blue-400 uppercase">Universitas Negeri Semarang</p>
                        </div>
                    </div>
                    <!-- Kanan: Info -->
                    <div class="p-6 md:p-8 md:w-2/3 flex flex-col justify-center space-y-6">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Pengembang</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-800">Yusril Yahya Muhaimin</p>
                            <p class="text-sm text-blue-600 font-medium">Mahasiswa Pendidikan Dasar</p>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Dosen Pembimbing</p>
                            <p class="text-lg font-semibold text-gray-800">Prof. Dr. Sri Wardani, M.Si.</p>
                        </div>
                        <div class="pt-4 border-t border-gray-100">
                            <p class="text-xs text-gray-500">Sekolah Pascasarjana Universitas Negeri Semarang &copy; 2025</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- NAVIGASI BAWAH (FIXED BOTTOM) -->
        <nav class="shrink-0 bg-white border-t border-gray-200 pb-[env(safe-area-inset-bottom)]">
            <!-- UPDATE: Grid 4 Kolom Seimbang (Tombol Floating QR Dihapus, Tombol Keluar Ditambahkan/Diperjelas) -->
            <div class="grid grid-cols-4 h-16 px-2 gap-2">
                <button data-page="page-awal" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="home" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Beranda</span>
                </button>
                <button data-page="page-materi" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="book-open" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Materi</span>
                </button>
                <button data-page="page-asesmen" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="calculator" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Kuis</span>
                </button>
                <!-- UPDATE: Tombol Profil digabungkan dengan exit logic jika perlu, tapi sesuai request: Tambahkan tombol keluar -->
                <!-- Kita buat Profil tombol ke-4, dan Exit tombol ke-5 (Tapi grid 4, jadi kita ubah grid ke 5) -->
            </div>
            <!-- Revisi: Grid 5 kolom untuk mengakomodasi Beranda, Materi, Kuis, Profil, Keluar -->
            <script>
                // Hack sedikit untuk inject ulang grid class karena di atas sudah dirender
                document.querySelector('nav > div').className = "grid grid-cols-5 h-16 px-2 gap-1";
            </script>
            <!-- Lanjutan tombol di dalam grid -->
            <!-- Tambahkan 2 tombol lagi di dalam grid yang sama -->
             <!-- (Code HTML nav di atas saya rewrite agar bersih) -->
        </nav>
        <!-- NAV REWRITE (Clean) -->
        <nav class="shrink-0 bg-white border-t border-gray-200 pb-[env(safe-area-inset-bottom)]" style="display: none;" id="real-nav">
            <div class="grid grid-cols-5 h-16 px-1 gap-1">
                 <button data-page="page-awal" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="home" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Beranda</span>
                </button>
                <button data-page="page-materi" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="book-open" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Materi</span>
                </button>
                <button data-page="page-asesmen" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="calculator" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Kuis</span>
                </button>
                 <button data-page="page-profil" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-gray-50">
                    <i data-lucide="user" class="w-5 h-5 text-gray-400 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-gray-400 mt-1">Profil</span>
                </button>
                <button id="exit-button-nav" class="group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-red-50 cursor-pointer">
                    <i data-lucide="log-out" class="w-5 h-5 text-red-500 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-medium text-red-500 mt-1">Keluar</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Canvas Hidden -->
    <canvas id="qr-canvas" class="hidden"></canvas>

    <script>
        // Fix Nav Display (Tukar elemen nav lama dengan yang baru)
        const realNav = document.getElementById('real-nav');
        const oldNav = document.querySelector('nav:not(#real-nav)');
        if(oldNav) oldNav.remove();
        if(realNav) realNav.style.display = 'block';

        // --- INIT LUCIDE ICONS ---
        lucide.createIcons();

        // --- STATE GLOBAL ---
        const state = {
            sensor: { alpha: 0, beta: 0, gamma: 0, gameQuat: null, isAbsolute: false },
            qr: { stream: null, animationId: null, active: false }
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app-container'),
            overlay: document.getElementById('sensor-permission-overlay'),
            grantBtn: document.getElementById('grant-permission-button'),
            status: document.getElementById('permission-status'),
            pages: document.querySelectorAll('.page'),
            navBtns: document.querySelectorAll('.nav-button'),
            
            // QR UI
            qrVideo: document.getElementById('qr-video'),
            qrCanvas: document.getElementById('qr-canvas'),
            qrCtx: document.getElementById('qr-canvas').getContext('2d'),
            qrContainer: document.getElementById('qr-scanner-container'),
            qrUI: document.getElementById('qr-scanner-ui'),
            qrStatus: document.getElementById('qr-status-message'),
            qrResult: document.getElementById('qr-result-container'),
            qrOutput: document.getElementById('qr-outputData'),
            qrFrame: document.getElementById('qr-outputFrame'),
            
            // Buttons
            copyBtn: document.getElementById('qr-copyButton'),
            linkBtn: document.getElementById('qr-openLinkButton'),
            scanAgainBtn: document.getElementById('qr-scanAgainButton'),
            exitBtnNav: document.getElementById('exit-button-nav'),
            
            // HUD
            hudA: document.getElementById('hud-alpha'),
            hudB: document.getElementById('hud-beta'),
            hudG: document.getElementById('hud-gamma'),
            hudQ: document.getElementById('hud-game-quaternion'),
            sensorInd: document.getElementById('sensor-indicator')
        };

        // --- FUNGSI UTILITAS ---
        const setActivePage = (pageId) => {
            // Hide all
            els.pages.forEach(p => {
                p.classList.add('hidden');
                p.classList.remove('animate-fade-in');
            });
            
            // Show active
            const active = document.getElementById(pageId);
            if(active) {
                active.classList.remove('hidden');
                active.classList.add('animate-fade-in');
            }

            // Update Nav Styles
            els.navBtns.forEach(btn => {
                const icon = btn.querySelector('svg');
                const text = btn.querySelector('span');
                const isActive = btn.dataset.page === pageId;
                
                if(icon) icon.classList.toggle('text-blue-600', isActive);
                if(icon) icon.classList.toggle('text-gray-400', !isActive);
                
                if(text) text.classList.toggle('text-blue-600', isActive);
                if(text) text.classList.toggle('text-gray-400', !isActive);
                if(text) text.classList.toggle('font-bold', isActive);
            });

            // Handle QR State
            if(pageId === 'page-materi') {
                startQR();
            } else {
                stopQR();
            }
        };

        // --- LOGIKA SENSOR ---
        const initSensors = async () => {
            els.status.textContent = "Menghubungkan ke sensor perangkat...";
            
            // 1. Device Orientation (Basic)
            if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
            }
            
            const handleOrientation = (e) => {
                // Deteksi apakah data absolute (kompas) atau relative
                const heading = e.webkitCompassHeading || e.alpha;
                const isAbs = e.absolute || (e.webkitCompassHeading !== undefined);
                
                state.sensor.alpha = heading;
                state.sensor.beta = e.beta;
                state.sensor.gamma = e.gamma;
                state.sensor.isAbsolute = isAbs;
                
                updateHUD();
            };

            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', (e) => handleOrientation({...e, absolute: true}));
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            // 2. Absolute Orientation Sensor (API Modern)
            if ('AbsoluteOrientationSensor' in window) {
                try {
                    const absSensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                    absSensor.addEventListener('reading', () => {
                        // Update HUD jika presisi tinggi
                    });
                    absSensor.start();
                } catch(e){ if(e.name!=='SecurityError') console.warn(e); }
            }

            // 3. Relative / Game Rotation
            if ('RelativeOrientationSensor' in window) {
                try {
                    const gameSensor = new RelativeOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                    gameSensor.addEventListener('reading', () => {
                        state.sensor.gameQuat = gameSensor.quaternion;
                        updateHUD();
                    });
                    gameSensor.addEventListener('error', (e) => {
                        els.hudQ.textContent = e.error.name === 'SecurityError' ? 'Blocked' : 'N/A';
                    });
                    gameSensor.start();
                } catch(e){}
            }

            els.status.textContent = "Sensor Aktif.";
        };

        const updateHUD = () => {
            // Update DOM minimal untuk performa
            if(els.qrContainer.offsetParent === null) return; // Skip jika hidden

            const { alpha, beta, gamma, gameQuat, isAbsolute } = state.sensor;
            
            els.hudA.textContent = `A:${alpha?.toFixed(0) || '-'}`;
            els.hudB.textContent = `B:${beta?.toFixed(0) || '-'}`;
            els.hudG.textContent = `G:${gamma?.toFixed(0) || '-'}`;
            
            if(gameQuat) {
                const [x,y,z,w] = gameQuat;
                els.hudQ.textContent = `x${x.toFixed(1)} y${y.toFixed(1)} z${z.toFixed(1)}`;
            }

            els.sensorInd?.classList.toggle('bg-green-500', true);
        };

        // --- LOGIKA QR SCANNER ---
        const startQR = async () => {
            if(state.qr.active) return;
            
            try {
                els.qrStatus.textContent = "Membuka kamera...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                state.qr.stream = stream;
                els.qrVideo.srcObject = stream;
                els.qrVideo.setAttribute("playsinline", true); // iOS fix
                
                // Tunggu metadata untuk memastikan ukuran
                els.qrVideo.onloadedmetadata = () => {
                    els.qrStatus.style.display = 'none';
                    els.qrContainer.classList.remove('hidden');
                    els.qrVideo.play();
                    state.qr.active = true;
                    state.qr.animationId = requestAnimationFrame(scanTick);
                };

            } catch(e) {
                console.error(e);
                els.qrStatus.textContent = "Gagal akses kamera: " + e.name;
            }
        };

        const stopQR = () => {
            if(!state.qr.active) return;
            
            if(state.qr.stream) {
                state.qr.stream.getTracks().forEach(t => t.stop());
                state.qr.stream = null;
            }
            if(state.qr.animationId) {
                cancelAnimationFrame(state.qr.animationId);
            }
            
            els.qrVideo.pause();
            els.qrVideo.srcObject = null;
            els.qrContainer.classList.add('hidden');
            els.qrStatus.style.display = 'flex';
            els.qrStatus.textContent = "Kamera Nonaktif";
            state.qr.active = false;
        };

        const scanTick = () => {
            if (els.qrVideo.readyState === els.qrVideo.HAVE_ENOUGH_DATA) {
                // Sync Canvas size dengan Video
                els.qrCanvas.height = els.qrVideo.videoHeight;
                els.qrCanvas.width = els.qrVideo.videoWidth;
                
                els.qrCtx.drawImage(els.qrVideo, 0, 0, els.qrCanvas.width, els.qrCanvas.height);
                const imageData = els.qrCtx.getImageData(0, 0, els.qrCanvas.width, els.qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    handleScanResult(code.data);
                    return; 
                }
            }
            if(state.qr.active) requestAnimationFrame(scanTick);
        };

        const handleScanResult = (data) => {
            els.qrResult.classList.remove('hidden');
            els.qrResult.classList.add('flex');
            els.qrOutput.value = data;

            const isUrl = /^(http|https):\/\/[^ "]+$/.test(data);
            
            if(isUrl) {
                els.qrFrame.src = data;
                document.getElementById('qr-iframe-preview').classList.remove('hidden');
                document.getElementById('qr-data-preview').classList.add('hidden');
                els.linkBtn.classList.remove('hidden');
                els.linkBtn.onclick = () => window.open(data, '_blank');
            } else {
                document.getElementById('qr-iframe-preview').classList.add('hidden');
                document.getElementById('qr-data-preview').classList.remove('hidden');
                els.linkBtn.classList.add('hidden');
            }
        };

        // --- EVENT LISTENERS ---
        
        // 1. Permission Grant
        els.grantBtn.addEventListener('click', async () => {
            els.grantBtn.disabled = true;
            els.grantBtn.textContent = "Menyiapkan...";
            
            await initSensors();
            
            // Pemanasan Kamera
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment'} });
                s.getTracks().forEach(t => t.stop());
            } catch(e){}

            // Animasi Transisi
            els.overlay.classList.add('opacity-0');
            setTimeout(() => {
                els.overlay.style.display = 'none';
                els.app.classList.remove('hidden');
                setActivePage('page-awal');
            }, 500);
        });

        // 2. Navigasi
        els.navBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const page = btn.dataset.page;
                if(page) setActivePage(page);
            });
        });

        // 3. Tombol Keluar
        if(els.exitBtnNav) {
            els.exitBtnNav.addEventListener('click', () => {
                if(confirm("Apakah Anda yakin ingin keluar dari aplikasi?")) {
                    // Percobaan menutup window dengan berbagai metode
                    window.open('','_self').close();
                    window.close();
                    // Fallback UI jika browser memblokir close
                    document.body.innerHTML = `
                        <div class="flex items-center justify-center h-screen w-screen bg-gray-900 text-white text-center p-4">
                            <div>
                                <h1 class="text-2xl font-bold mb-2">Aplikasi Ditutup</h1>
                                <p class="text-gray-400">Anda dapat menutup tab ini secara manual.</p>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // 4. QR Actions
        els.scanAgainBtn.addEventListener('click', () => {
            els.qrResult.classList.add('hidden');
            els.qrResult.classList.remove('flex');
            els.qrFrame.src = 'about:blank';
            els.qrVideo.play();
            scanTick();
        });

        els.copyBtn.addEventListener('click', () => {
            els.qrOutput.select();
            document.execCommand('copy');
            const originalText = els.copyBtn.textContent;
            els.copyBtn.textContent = "Tersalin!";
            setTimeout(() => els.copyBtn.textContent = originalText, 1500);
        });

        window.addEventListener('resize', () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        // Init
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);

    </script>
</body>
</html>
