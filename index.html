<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport setting untuk mencegah zoom yang tidak disengaja dan memastikan skala 1:1 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NUMERASIYU - HD 720p</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Memuat pustaka jsQR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* Fallback untuk browser yang tidak support dvh */
            --vh: 1vh; 
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            background-color: #111827; 
        }
        
        .page.hidden { display: none; }

        /* Utilitas Transisi Halus */
        .transition-layout {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scanner Styles */
        #qr-scanner-container {
            background-color: #000;
            position: relative;
        }
        
        /* Styling khusus saat elemen dalam mode fullscreen */
        #qr-scanner-container:fullscreen {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Animasi Laser Scanner */
        @keyframes scan-line {
            0% { top: 10%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }
        .scan-laser {
            position: absolute;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: scan-line 2s infinite linear;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <!-- Hamparan Izin Sensor (Overlay) -->
    <div id="sensor-permission-overlay" class="fixed inset-0 bg-black/90 z-[9999] flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center space-y-4">
            <div class="mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                <i data-lucide="scan-face" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900">Selamat Datang!</h2>
            <p class="text-sm text-gray-500">Aplikasi ini membutuhkan akses kamera dan sensor gerak untuk fitur interaktif.</p>
            <button id="grant-permission-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <span>Mulai Sekarang</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
            <p id="permission-status" class="text-[10px] text-gray-400 italic min-h-[1rem]"></p>
        </div>
    </div>

    <!-- Container Utama -->
    <div id="app-container" class="flex flex-col w-full h-full hidden max-w-[1280px] bg-white shadow-2xl mx-auto relative">
        
        <!-- Area Konten Utama -->
        <main class="flex-grow relative overflow-hidden w-full h-full bg-gray-50">
            
            <!-- PAGE 1: BERANDA -->
            <div id="page-awal" class="page w-full h-full relative flex flex-col items-center justify-center p-6">
                <div class="absolute inset-0 z-0">
                    <img src="https://cdn.pixabay.com/photo/2021/05/05/11/43/modern-6230891_1280.png" class="w-full h-full object-cover" alt="Background">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/30 via-white/60 to-white/90"></div>
                </div>

                <div class="relative z-10 flex flex-col items-center max-w-md w-full text-center animate-fade-in-up">
                    <div class="w-32 h-32 md:w-40 md:h-40 bg-white rounded-3xl shadow-xl p-2 mb-6 flex items-center justify-center transform hover:scale-105 transition-transform duration-300">
                        <img src="Numerasiyu-icon.jpeg" 
                             alt="Logo Numerasiyu" 
                             class="w-full h-full object-contain rounded-2xl"
                             onerror="this.src='https://placehold.co/200x200/FFD700/000000?text=Numerasiyu'; this.onerror=null;">
                    </div>
                    
                    <div class="bg-white px-8 py-4 rounded-xl shadow-md border-l-4 border-blue-500 mb-6">
                        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-yellow-500">NUMERASIYU</h1>
                    </div>
                    <div class="h-1 w-16 bg-yellow-400 rounded-full mb-4 shadow-sm"></div>
                    <p class="text-gray-700 text-sm md:text-base font-bold bg-white/50 backdrop-blur-sm px-4 py-1 rounded-full">Ayo belajar data <br>Berbasis Augmented Reality</p>
                    
                    <div class="mt-8 grid grid-cols-2 gap-3 w-full px-4">
                        <div class="bg-white/90 backdrop-blur p-3 rounded-lg border border-blue-100 shadow-md flex flex-col items-center gap-1 hover:bg-white transition-colors">
                            <i data-lucide="scan" class="w-5 h-5 text-blue-600"></i>
                            <span class="text-xs font-bold text-gray-700">QR Scan</span>
                        </div>
                        <div class="bg-white/90 backdrop-blur p-3 rounded-lg border border-green-100 shadow-md flex flex-col items-center gap-1 hover:bg-white transition-colors">
                            <i data-lucide="compass" class="w-5 h-5 text-green-600"></i>
                            <span class="text-xs font-bold text-gray-700">Sensor AR</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: MATERI & SCANNER -->
            <div id="page-materi" class="page w-full h-full hidden flex flex-col p-2 md:p-4 gap-2 md:gap-4">
                <div class="flex items-center gap-2 px-1 shrink-0">
                    <div class="p-1.5 bg-green-100 rounded-lg">
                        <i data-lucide="layers" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <h2 class="font-bold text-gray-800">Materi & Aktivitas</h2>
                </div>

                <div class="flex-grow flex flex-col md:flex-row landscape:flex-row gap-3 min-h-0 overflow-hidden">
                    
                    <!-- KIRI/ATAS: Iframe Materi -->
                    <div class="flex-1 bg-gray-100 rounded-xl border border-gray-200 overflow-hidden relative shadow-sm group">
                        <div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-md backdrop-blur z-10">Slide</div>
                        <iframe src="https://www.canva.com/design/DAG4vcThXDs/0x7N7lcxNemZgrtoXQ5JJg/view?embed" 
                                class="w-full h-full border-0" 
                                allow="fullscreen" loading="lazy"></iframe>
                    </div>

                    <!-- KANAN/BAWAH: Scanner -->
                    <div class="flex-1 flex flex-col bg-white rounded-xl border border-blue-100 shadow-sm overflow-hidden">
                        <div class="p-2 border-b border-gray-100 flex justify-between items-center bg-blue-50/50 shrink-0">
                            <span class="text-xs font-bold text-blue-800 flex items-center gap-1">
                                <i data-lucide="scan-line" class="w-3 h-3"></i> Scanner
                            </span>
                            <div class="flex gap-1">
                                <span id="sensor-indicator" class="w-2 h-2 rounded-full bg-gray-300"></span>
                            </div>
                        </div>

                        <div id="qr-scanner-ui" class="flex-grow relative bg-black w-full min-h-0">
                            <div id="qr-status-message" class="absolute inset-0 flex items-center justify-center text-white/70 text-xs p-4 text-center">
                                Menyiapkan kamera...
                            </div>

                            <!-- Container Video -->
                            <div id="qr-scanner-container" class="absolute inset-0 hidden group">
                                <video id="qr-video" playsinline muted autoplay></video>
                                
                                <!-- Tombol Fullscreen (BARU) -->
                                <button id="scanner-fullscreen-btn" class="absolute top-4 right-4 z-30 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur-sm transition-all pointer-events-auto">
                                    <i data-lucide="maximize" class="w-5 h-5"></i>
                                </button>

                                <!-- Overlay UI -->
                                <div class="absolute inset-0 pointer-events-none">
                                    <div class="absolute top-1/2 left-6 right-6 h-0.5 bg-red-500 shadow-[0_0_8px_rgba(255,0,0,0.8)] animate-scan-pulse pointer-events-none"></div>
                                    <div class="scan-laser"></div>
                                </div>

                                <!-- HUD Data Sensor -->
                                <div class="absolute top-2 left-2 right-12 flex flex-col gap-1 pointer-events-none">
                                    <div class="flex gap-1">
                                        <div class="bg-black/60 backdrop-blur text-white text-[9px] font-mono p-1 rounded border border-white/10 flex-1">
                                            <div class="text-yellow-400 font-bold mb-0.5">COMPASS (ABS)</div>
                                            <div class="grid grid-cols-3 gap-1">
                                                <span id="hud-alpha">A:--</span>
                                                <span id="hud-beta">B:--</span>
                                                <span id="hud-gamma">G:--</span>
                                            </div>
                                        </div>
                                        <div class="bg-black/60 backdrop-blur text-white text-[9px] font-mono p-1 rounded border border-white/10 flex-1">
                                            <div class="text-green-400 font-bold mb-0.5">GAME ROTATION</div>
                                            <div id="hud-game-quaternion" class="truncate">Waiting...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hasil Scan Overlay -->
                            <div id="qr-result-container" class="absolute inset-0 bg-white z-20 hidden flex-col">
                                <div class="flex-1 relative bg-gray-50">
                                    <div id="qr-iframe-preview" class="absolute inset-0 hidden">
                                        <iframe id="qr-outputFrame" class="w-full h-full border-0"></iframe>
                                    </div>
                                    <div id="qr-data-preview" class="absolute inset-0 p-4 flex items-center justify-center hidden">
                                        <textarea id="qr-outputData" class="w-full h-32 p-2 text-sm bg-white border rounded resize-none" readonly></textarea>
                                    </div>
                                </div>
                                <div class="p-2 border-t bg-white flex gap-2 shrink-0">
                                    <button id="qr-copyButton" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-xs font-bold hover:bg-gray-200">Salin</button>
                                    <button id="qr-openLinkButton" class="flex-1 bg-purple-100 text-purple-700 py-2 rounded-lg text-xs font-bold hover:bg-purple-200 hidden">Buka Link</button>
                                    <button id="qr-scanAgainButton" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700">Scan Lagi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: ASESMEN -->
            <div id="page-asesmen" class="page w-full h-full hidden flex flex-col p-2 md:p-4 gap-2">
                <div class="flex items-center gap-2 px-1 shrink-0">
                    <div class="p-1.5 bg-red-100 rounded-lg">
                        <i data-lucide="calculator" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <h2 class="font-bold text-gray-800">Kuis & Evaluasi</h2>
                </div>
                <div class="flex-grow bg-white rounded-xl border border-red-100 shadow-sm overflow-hidden relative">
                    <iframe src="https://wayground.com/embed/quiz/66dc55162cbae50f1111bf98" 
                            class="w-full h-full border-0" 
                            allow="fullscreen"></iframe>
                </div>
            </div>

            <!-- PAGE 4: PROFIL -->
            <div id="page-profil" class="page w-full h-full hidden flex flex-col p-4 md:p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col md:flex-row">
                    <!-- Kiri: Foto/Logo -->
                    <div class="bg-blue-50 p-8 flex items-center justify-center md:w-1/3 border-b md:border-b-0 md:border-r border-blue-100">
                        <div class="text-center">
                            <img src="https://unnes.ac.id/lppm/wp-content/uploads/sites/16/2015/08/Logo-Transparan-Warna-1.png" 
                                 class="w-32 h-auto mx-auto mb-4 drop-shadow-sm hover:scale-110 transition-transform" 
                                 alt="UNNES"
                                 onerror="this.src='https://placehold.co/150x150/F9E45B/003399?text=UNNES'; this.onerror=null;">
                            <h3 class="font-bold text-blue-900 text-lg">2499010072</h3>
                            <p class="text-[10px] font-bold tracking-widest text-blue-400 uppercase">2025</p>
                        </div>
                    </div>
                    <!-- Kanan: Info -->
                    <div class="p-6 md:p-8 md:w-2/3 flex flex-col justify-center space-y-6">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Pengembang</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-800">Yusril Yahya Muhaimin</p>
                            <p class="text-sm text-blue-600 font-medium">Mahasiswa Pendidikan Dasar</p>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Dosen Pembimbing</p>
                            <p class="text-lg font-semibold text-gray-800">Prof. Dr. Sri Wardani, M.Si.</p>
                        </div>
                        <div class="pt-4 border-t border-gray-100">
                            <p class="text-xs text-gray-500">Sekolah Pascasarjana Universitas Negeri Semarang &copy; 2025</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- NAVIGASI BAWAH -->
        <nav class="shrink-0 bg-[#FFD700] border-t border-yellow-500 pb-[env(safe-area-inset-bottom)] shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <div class="grid grid-cols-5 h-16 px-1 gap-1">
                 <button data-page="page-awal" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-white/30">
                    <i data-lucide="home" class="w-5 h-5 text-gray-800 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-800 mt-1">Beranda</span>
                </button>
                <button data-page="page-materi" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-white/30">
                    <i data-lucide="book-open" class="w-5 h-5 text-gray-800 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-800 mt-1">Materi</span>
                </button>
                <button data-page="page-asesmen" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-white/30">
                    <i data-lucide="calculator" class="w-5 h-5 text-gray-800 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-800 mt-1">Kuis</span>
                </button>
                 <button data-page="page-profil" class="nav-button group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-white/30">
                    <i data-lucide="user" class="w-5 h-5 text-gray-800 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-gray-800 mt-1">Profil</span>
                </button>
                <button id="exit-button-nav" class="group flex flex-col items-center justify-center py-1 rounded-xl transition-all hover:bg-red-500/20 cursor-pointer">
                    <i data-lucide="log-out" class="w-5 h-5 text-red-600 group-hover:scale-110 transition-transform"></i>
                    <span class="text-[10px] font-bold text-red-600 mt-1">Keluar</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Canvas Hidden -->
    <canvas id="qr-canvas" class="hidden"></canvas>

    <script>
        // --- INIT LUCIDE ICONS ---
        lucide.createIcons();

        // --- STATE GLOBAL ---
        const state = {
            sensor: { alpha: 0, beta: 0, gamma: 0, gameQuat: null, isAbsolute: false },
            qr: { stream: null, animationId: null, active: false }
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app-container'),
            overlay: document.getElementById('sensor-permission-overlay'),
            grantBtn: document.getElementById('grant-permission-button'),
            status: document.getElementById('permission-status'),
            pages: document.querySelectorAll('.page'),
            navBtns: document.querySelectorAll('.nav-button'),
            
            // QR UI
            qrVideo: document.getElementById('qr-video'),
            qrCanvas: document.getElementById('qr-canvas'),
            qrCtx: document.getElementById('qr-canvas').getContext('2d'),
            qrContainer: document.getElementById('qr-scanner-container'),
            qrUI: document.getElementById('qr-scanner-ui'),
            qrStatus: document.getElementById('qr-status-message'),
            qrResult: document.getElementById('qr-result-container'),
            qrOutput: document.getElementById('qr-outputData'),
            qrFrame: document.getElementById('qr-outputFrame'),
            fullscreenBtn: document.getElementById('scanner-fullscreen-btn'), // Tombol Baru
            
            // Buttons
            copyBtn: document.getElementById('qr-copyButton'),
            linkBtn: document.getElementById('qr-openLinkButton'),
            scanAgainBtn: document.getElementById('qr-scanAgainButton'),
            exitBtnNav: document.getElementById('exit-button-nav'),
            
            // HUD
            hudA: document.getElementById('hud-alpha'),
            hudB: document.getElementById('hud-beta'),
            hudG: document.getElementById('hud-gamma'),
            hudQ: document.getElementById('hud-game-quaternion'),
            sensorInd: document.getElementById('sensor-indicator')
        };

        // --- FUNGSI UTILITAS ---
        const setActivePage = (pageId) => {
            // Hide all
            els.pages.forEach(p => {
                p.classList.add('hidden');
                p.classList.remove('animate-fade-in');
            });
            
            // Show active
            const active = document.getElementById(pageId);
            if(active) {
                active.classList.remove('hidden');
                active.classList.add('animate-fade-in');
            }

            // Update Nav Styles (Warna Khusus per Menu)
            els.navBtns.forEach(btn => {
                const icon = btn.querySelector('svg');
                const text = btn.querySelector('span');
                const isActive = btn.dataset.page === pageId;
                const pageName = btn.dataset.page;
                
                // Reset base classes (Default: Abu-abu Gelap)
                if(icon) {
                    icon.setAttribute('class', `w-5 h-5 group-hover:scale-110 transition-transform ${isActive ? '' : 'text-gray-800'}`);
                }
                if(text) {
                    text.setAttribute('class', `text-[10px] mt-1 ${isActive ? 'font-extrabold' : 'font-bold text-gray-800'}`);
                }
                
                // Apply Active Colors
                if(isActive) {
                    btn.classList.add('bg-white/40', 'shadow-sm');
                    
                    // Warna Khusus berdasarkan Halaman
                    let activeColorClass = 'text-gray-900'; // Fallback
                    
                    if (pageName === 'page-awal') activeColorClass = 'text-sky-600'; // Biru Muda
                    else if (pageName === 'page-materi') activeColorClass = 'text-green-600'; // Hijau
                    else if (pageName === 'page-asesmen') activeColorClass = 'text-red-600'; // Merah
                    else if (pageName === 'page-profil') activeColorClass = 'text-blue-900'; // Biru Tua
                    
                    if(icon) icon.classList.add(activeColorClass);
                    if(text) text.classList.add(activeColorClass);
                    
                } else {
                    btn.classList.remove('bg-white/40', 'shadow-sm');
                }
            });

            // Handle QR State
            if(pageId === 'page-materi') {
                startQR();
            } else {
                stopQR();
            }
        };

        // --- LOGIKA SENSOR ---
        const initSensors = async () => {
            els.status.textContent = "Menghubungkan ke sensor perangkat...";
            
            // 1. Device Orientation
            if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
            }
            
            const handleOrientation = (e) => {
                const heading = e.webkitCompassHeading || e.alpha;
                const isAbs = e.absolute || (e.webkitCompassHeading !== undefined);
                
                state.sensor.alpha = heading;
                state.sensor.beta = e.beta;
                state.sensor.gamma = e.gamma;
                state.sensor.isAbsolute = isAbs;
                
                updateHUD();
            };

            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', (e) => handleOrientation({...e, absolute: true}));
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            // 2. Modern Sensors
            if ('AbsoluteOrientationSensor' in window) {
                try {
                    const absSensor = new AbsoluteOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                    absSensor.start();
                } catch(e){}
            }

            if ('RelativeOrientationSensor' in window) {
                try {
                    const gameSensor = new RelativeOrientationSensor({ frequency: 60, referenceFrame: 'device' });
                    gameSensor.addEventListener('reading', () => {
                        state.sensor.gameQuat = gameSensor.quaternion;
                        updateHUD();
                    });
                    gameSensor.start();
                } catch(e){}
            }

            els.status.textContent = "Sensor Aktif.";
        };

        const updateHUD = () => {
            if(els.qrContainer.offsetParent === null) return;

            const { alpha, beta, gamma, gameQuat } = state.sensor;
            
            els.hudA.textContent = `A:${alpha?.toFixed(0) || '-'}`;
            els.hudB.textContent = `B:${beta?.toFixed(0) || '-'}`;
            els.hudG.textContent = `G:${gamma?.toFixed(0) || '-'}`;
            
            if(gameQuat) {
                const [x,y,z,w] = gameQuat;
                els.hudQ.textContent = `x${x.toFixed(1)} y${y.toFixed(1)} z${z.toFixed(1)}`;
            }

            els.sensorInd?.classList.toggle('bg-green-500', true);
        };

        // --- LOGIKA QR SCANNER ---
        const startQR = async () => {
            if(state.qr.active) return;
            
            try {
                els.qrStatus.textContent = "Membuka kamera...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                state.qr.stream = stream;
                els.qrVideo.srcObject = stream;
                els.qrVideo.setAttribute("playsinline", true);
                
                els.qrVideo.onloadedmetadata = () => {
                    els.qrStatus.style.display = 'none';
                    els.qrContainer.classList.remove('hidden');
                    els.qrVideo.play();
                    state.qr.active = true;
                    state.qr.animationId = requestAnimationFrame(scanTick);
                };

            } catch(e) {
                console.error(e);
                els.qrStatus.textContent = "Gagal akses kamera: " + e.name;
            }
        };

        const stopQR = () => {
            if(!state.qr.active) return;
            
            if(state.qr.stream) {
                state.qr.stream.getTracks().forEach(t => t.stop());
                state.qr.stream = null;
            }
            if(state.qr.animationId) {
                cancelAnimationFrame(state.qr.animationId);
            }
            
            els.qrVideo.pause();
            els.qrVideo.srcObject = null;
            els.qrContainer.classList.add('hidden');
            els.qrStatus.style.display = 'flex';
            els.qrStatus.textContent = "Kamera Nonaktif";
            state.qr.active = false;
        };

        const scanTick = () => {
            if (els.qrVideo.readyState === els.qrVideo.HAVE_ENOUGH_DATA) {
                els.qrCanvas.height = els.qrVideo.videoHeight;
                els.qrCanvas.width = els.qrVideo.videoWidth;
                
                els.qrCtx.drawImage(els.qrVideo, 0, 0, els.qrCanvas.width, els.qrCanvas.height);
                const imageData = els.qrCtx.getImageData(0, 0, els.qrCanvas.width, els.qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code) {
                    handleScanResult(code.data);
                    return; 
                }
            }
            if(state.qr.active) requestAnimationFrame(scanTick);
        };

        const handleScanResult = (data) => {
            els.qrResult.classList.remove('hidden');
            els.qrResult.classList.add('flex');
            els.qrOutput.value = data;

            const isUrl = /^(http|https):\/\/[^ "]+$/.test(data);
            
            if(isUrl) {
                els.qrFrame.src = data;
                document.getElementById('qr-iframe-preview').classList.remove('hidden');
                document.getElementById('qr-data-preview').classList.add('hidden');
                els.linkBtn.classList.remove('hidden');
                els.linkBtn.onclick = () => window.open(data, '_blank');
            } else {
                document.getElementById('qr-iframe-preview').classList.add('hidden');
                document.getElementById('qr-data-preview').classList.remove('hidden');
                els.linkBtn.classList.add('hidden');
            }
        };

        // --- LOGIKA FULLSCREEN ---
        els.fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                els.qrContainer.requestFullscreen().catch(err => {
                    alert(`Gagal fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        // Ubah ikon toggle fullscreen
        document.addEventListener('fullscreenchange', () => {
            const icon = els.fullscreenBtn.querySelector('svg');
            // Kita perlu re-init icon atau swap manual karena Lucide merender SVG
            // Cara sederhana: ganti innerHTML
            if (document.fullscreenElement) {
                els.fullscreenBtn.innerHTML = '<i data-lucide="minimize" class="w-5 h-5"></i>';
            } else {
                els.fullscreenBtn.innerHTML = '<i data-lucide="maximize" class="w-5 h-5"></i>';
            }
            lucide.createIcons();
        });

        // --- EVENT LISTENERS ---
        
        els.grantBtn.addEventListener('click', async () => {
            els.grantBtn.disabled = true;
            els.grantBtn.textContent = "Menyiapkan...";
            
            await initSensors();
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment'} });
                s.getTracks().forEach(t => t.stop());
            } catch(e){}

            els.overlay.classList.add('opacity-0');
            setTimeout(() => {
                els.overlay.style.display = 'none';
                els.app.classList.remove('hidden');
                setActivePage('page-awal');
            }, 500);
        });

        els.navBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const page = btn.dataset.page;
                if(page) setActivePage(page);
            });
        });

        if(els.exitBtnNav) {
            els.exitBtnNav.addEventListener('click', () => {
                window.open('','_self').close();
                window.close();
                document.body.innerHTML = `
                    <div class="flex items-center justify-center h-screen w-screen bg-gray-900 text-white text-center p-4">
                        <div>
                            <h1 class="text-2xl font-bold mb-2">Aplikasi Ditutup</h1>
                            <p class="text-gray-400">Anda dapat menutup tab ini secara manual.</p>
                        </div>
                    </div>
                `;
            });
        }

        els.scanAgainBtn.addEventListener('click', () => {
            els.qrResult.classList.add('hidden');
            els.qrResult.classList.remove('flex');
            els.qrFrame.src = 'about:blank';
            els.qrVideo.play();
            scanTick();
        });

        els.copyBtn.addEventListener('click', () => {
            els.qrOutput.select();
            document.execCommand('copy');
            const originalText = els.copyBtn.textContent;
            els.copyBtn.textContent = "Tersalin!";
            setTimeout(() => els.copyBtn.textContent = originalText, 1500);
        });

        window.addEventListener('resize', () => {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });

        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);

    </script>
</body>
</html>
